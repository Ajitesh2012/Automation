timestamps{

node () {
    
    withCredentials([string(credentialsId: 'DD', variable: 'API_DD')]){
    cleanWs()
                stage ('Pull_Code and Build') {
                   checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '', url: 'https://github.com/praveendvd/juice-shop.git']]]) 
        sh """npm install"""
        sh """sudo docker build -t praveen/juiceshop:latest ."""
                }
                
                stage ('Check For Secrets-Talisman') {
                 
                          sh """/home/praveen/Shell_Scripts/talisman/talisman2html.sh"""

                }
                
                stage ('DependencyScan-snyk - Scan') {
               
                sh """#!/bin/bash
                mkdir testresults
                snyk test --json --severity-threshold=low > testresults/snyk_report.json
                exit 0"""

        sh """/home/praveen/Shell_Scripts/DependencyScan-snyk/Snyk2DD.sh"""
                    
                }
                
                stage ('ScanDependency-retirejs - Build') {
            sh """retire --exitwith=0 --outputformat=json --outputpath=testresults/RetireResults.json """     
            sh """/home/praveen/Shell_Scripts/Retirejs-scan/Retire2HTML.sh"""
            sh """/home/praveen/Shell_Scripts/Retirejs-scan/Retire2DD.sh"""
                }
                
                stage ('SAST_Sonarqube - Build') {
                    
         def scannerHome = tool 'SonarScanner';
            withSonarQubeEnv(installationName:'SonarQube_Sever',credentialsId: 'sonartoken') { 
              sh """${scannerHome}/bin/sonar-scanner -Dsonar.projectKey=Juice \
          -Dsonar.sources=. \
          -Dsonar.host.url=http://localhost:9000"""
        }
        
        sh """/home/praveen/Shell_Scripts/SonarQube/Sonar2Html.sh"""
        
        sh """/home/praveen/Shell_Scripts/SonarQube/Sonar2DD.sh"""
                }
                
                stage ('Selelnium+Zap - Checkout') {
                    
                checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '', url: 'https://github.com/praveendvd/JuiceShopSelenium.git']]]) 
        sh """/home/praveen/Shell_Scripts/ZAP+Selenium/test.sh"""
        sh """/home/praveen/Shell_Scripts/ZAP+Selenium/Zap2DD.sh"""
                archiveArtifacts allowEmptyArchive: true, artifacts: 'testresults/*, SeleniumTutorial/target/surefire-reports/' 
                }
}
        
    }

}
